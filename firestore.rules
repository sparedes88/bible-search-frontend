rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // üîê Helper Functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isGlobalAdmin() {
      return isAuthenticated() &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'global_admin';
    }

    function isChurchAdmin(churchId) {
      let userDoc = get(/databases/$(database)/documents/users/$(request.auth.uid));
      return isAuthenticated() && (
        userDoc.data.role == 'global_admin' ||
        (userDoc.data.role == 'admin' && userDoc.data.churchId == churchId)
      );
    }

    function isUserInChurch(churchId) {
      return request.auth.uid != null &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.churchId == churchId;
    }

    // ‚úÖ Users
    match /users/{userId} {
      function isMember() {
        return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'member';
      }

      function isOwner() {
        return request.auth.uid == userId;
      }

      // Allow querying users by churchId for admin connections
      allow list: if isAuthenticated() && 
                  ('churchId' in request.query.filters) &&
                  (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.churchId == request.query.filters.churchId[0] || 
                   get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'global_admin');

      // Allow querying users by phone or email for lookup purposes (event check-in, login, etc)
      allow list: if isAuthenticated() && 
                   (('phone' in request.query.filters) || ('email' in request.query.filters));

      allow read: if isAuthenticated() && isMember() && isOwner();

      allow update: if isAuthenticated() &&
                      isMember() &&
                      isOwner() &&
                      !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role']);

      // Allow authenticated users to create their own profile during signup
      allow create: if isAuthenticated() && request.auth.uid == userId;

      allow read: if isAuthenticated() &&
        (userId == request.auth.uid ||
         resource.data.churchId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.churchId);

      allow read, write, delete: if isGlobalAdmin();

      allow update: if isAuthenticated() &&
        request.auth.uid == userId &&
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['fcmToken']);
    }

    // ‚úÖ Progress Collection
    match /progress/{progressId} {
      allow read: if isAuthenticated() &&
        (resource.data.userId == request.auth.uid ||
         isUserInChurch(resource.data.churchId));
      allow write: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid;
    }

    // ‚úÖ Course Categories
    match /coursecategories/{categoryId} {
      allow read: if true;
      allow create, update, delete: if isChurchAdmin(request.resource.data.churchId);
    }

      // ‚úÖ Course Topics
      match /coursetopics/{topicId} {
        allow read: if true;
        // Add write rules as needed
      }

    // ‚úÖ Event Instances
    match /eventInstances/{eventId} {
      allow read: if true;
      allow write, delete: if isChurchAdmin(resource.data.churchId);
    }

    // ‚úÖ Events
    match /events/{eventId} {
      allow read: if true;
      allow write, delete: if isAuthenticated() && 
        (isChurchAdmin(resource.data.churchId) || isGlobalAdmin());
    }

    // ‚úÖ Churches and Subcollections
    match /churches/{churchId} {
      allow read: if true;
      allow write: if isAuthenticated();

      match /broadcasts/{broadcastId} {
        allow read: if true;
        allow write: if isAuthenticated();
      }

      match /songs/{songId} {
        allow read: if true;
        allow write: if isAuthenticated();
      }

      match /courses/{courseId} {
        allow read: if isAuthenticated();
        allow write: if isChurchAdmin(churchId);
      }

      match /quickCards/{cardId} {
        allow read: if true;
        allow write: if isChurchAdmin(churchId);
      }

      match /categories/{categoryId} {
        allow read: if isAuthenticated();
        allow write: if isChurchAdmin(churchId);
      }

      match /members/{memberId} {
        allow read, write, delete: if isChurchAdmin(churchId);
      }

      match /visitors/{visitorId} {
        allow create: if isAuthenticated() && isChurchAdmin(churchId);
        allow read, update, delete: if isChurchAdmin(churchId);
      }

      match /config/process {
        allow read, write: if isAuthenticated() && isChurchAdmin(churchId);
      }
      
      // Social Media permissions - allow admin role to CRUD
      match /socialMedia/{postId} {
        allow read, write, create, update, delete: if isChurchAdmin(churchId);
      }
      
      // Social Media Accounts permissions - allow admin role to CRUD
      match /socialMediaAccounts/{accountId} {
        allow read, write, create, update, delete: if isChurchAdmin(churchId);
      }
      
      // Forms - Admin/Global admin can CRUD, authenticated users can read active forms
      match /forms/{formId} {
        allow read: if isAuthenticated() || (resource.data.isActive == true);
        allow write, create, update, delete: if isChurchAdmin(churchId);
        
        // Form entries - anyone can create, admin can CRUD
        match /entries/{entryId} {
          allow create: if true; // Allow anonymous submissions
          allow read, update, delete: if isChurchAdmin(churchId);
        }
      }
      
      // Time Tracking - Users can CRUD their own entries
      match /timeEntries/{entryId} {
        allow read, write, create, update, delete: if isAuthenticated() && 
          (resource.data.userId == request.auth.uid || request.resource.data.userId == request.auth.uid);
      }
      
      // Tasks - Users can CRUD their own tasks
      match /tasks/{taskId} {
        allow read, write, create, update, delete: if isAuthenticated() && 
          (resource.data.userId == request.auth.uid || request.resource.data.userId == request.auth.uid);
      }
      
      // Build Tasks - Church members can access tasks for their church
      match /buildTasks/{taskId} {
        allow read, write, create, update, delete: if isAuthenticated() && 
          isUserInChurch(resource.data.churchId);
        // Allow subcollections like comments
        match /comments/{commentId} {
          allow read, write, create, update, delete: if isAuthenticated() && 
            isUserInChurch(get(/databases/$(database)/documents/buildTasks/$(taskId)).data.churchId);
        }
      }
      
      // Task Progress - Users can CRUD their own progress entries
      match /taskProgress/{progressId} {
        allow read, write, create, update, delete: if isAuthenticated() && 
          (resource.data.userId == request.auth.uid || request.resource.data.userId == request.auth.uid);
      }
      
      // Submissions - Users can CRUD their own submissions
      match /submissions/{submissionId} {
        allow read, write, create, update, delete: if isAuthenticated() && 
          (resource.data.userId == request.auth.uid || request.resource.data.userId == request.auth.uid);
      }
      
      // Areas of Focus - Users can CRUD their own areas
      match /areasOfFocus/{areaId} {
        allow read, write, create, update, delete: if isAuthenticated() && 
          (resource.data.userId == request.auth.uid || request.resource.data.userId == request.auth.uid);
      }
      
      // Cost Codes - Users can CRUD their own cost codes
      match /costCodes/{costCodeId} {
        allow read, write, create, update, delete: if isAuthenticated() && 
          (resource.data.userId == request.auth.uid || request.resource.data.userId == request.auth.uid);
      }
    }

    // ‚úÖ Visitors Collection (Top-level)
    match /visitors/{churchId}/visitors/{visitorId} {
      // Allow admins and authenticated users to read/query visitors in their church
      allow read, list: if isAuthenticated() && 
        (isChurchAdmin(churchId) || 
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.churchId == churchId);
      // Allow admins and authenticated users to create/update visitors
      allow create, update: if isAuthenticated() && 
        (isChurchAdmin(churchId) || 
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.churchId == churchId);
      // Only admins can delete
      allow delete: if isChurchAdmin(churchId);
    }

    // ‚úÖ Completion Logs
    match /completionLogs/{logId} {
      allow read: if isAuthenticated() &&
        (resource.data.userId == request.auth.uid ||
         isUserInChurch(resource.data.churchId));
      allow write: if isAuthenticated() &&
        (request.resource.data.userId == request.auth.uid ||
         isUserInChurch(request.resource.data.churchId));
    }

    // ‚úÖ Categories
    match /categories/{categoryId} {
      allow read: if isAuthenticated();
    }

    // ‚úÖ Courses
    match /courses/{courseId} {
      allow read: if isAuthenticated();
    }

    // ‚úÖ Media
    match /media/{mediaId} {
      allow read: if true;
      allow write, delete: if isChurchAdmin(resource.data.churchId);
    }

    match /playlist/{playlistId} {
      allow read: if isAuthenticated();
      allow write, delete: if isChurchAdmin(resource.data.churchId);
    }

    match /syncChurchPlaylist/{syncId} {
      allow read: if isAuthenticated();
      allow write, delete: if isChurchAdmin(resource.data.churchId);
    }

    // ‚úÖ Gallery
    match /gallery_new/{galleryId} {
      allow read: if true;
      allow write, delete: if isChurchAdmin(resource.data.churchId);
    }

    match /gallery_images/{imageId} {
      allow read: if true;
      allow write, delete: if isChurchAdmin(resource.data.churchId);
    }

    // ‚úÖ Chats & Messaging
    match /chats/{chatId} {
      allow read, write, delete: if isAuthenticated();
    }

    match /messages/{messageId} {
      allow read, write, delete: if isAuthenticated();
    }

    match /chat_members/{memberId} {
      allow read, write, delete: if isAuthenticated();
    }

    // ‚úÖ Group Messaging
    match /groups/{groupId} {
      allow read, write, delete: if isAuthenticated();

      match /messages/{messageId} {
        allow read, write, delete: if isAuthenticated();
      }

      match /readStatus/{statusId} {
        allow read, write, delete: if isAuthenticated();
      }

      match /typingStatus/{typingId} {
        allow read, write, delete: if isAuthenticated();
      }
    }

    // ‚úÖ Profiles
    match /{path=**}/profiles/{profileId} {
      allow read: if isAuthenticated();
      allow write, delete: if isAuthenticated() && request.auth.uid == profileId;
    }

    // ‚úÖ Reference Data
    match /{collection}/{docId} {
      allow read: if isAuthenticated() &&
        collection in ['Family', 'Nationalities', 'Profession', 'language', 'skills'];
      allow write, delete: if isGlobalAdmin();
    }

    // ‚úÖ Event Registrations
    match /eventRegistrations/{registrationId} {
      // Anyone can read registrations
      // For public users, we use client-side filtering to limit visible fields
      allow read: if true;
      
      // Anyone can create a registration
      allow create: if true;
      
      // Only admins and global admins can update or delete registrations
      allow update, delete: if isAuthenticated() && 
        (isChurchAdmin(resource.data.churchId) || isGlobalAdmin());
    }

    // ‚úÖ Brands (for filtering churches)
    match /brands/{brandId} {
      allow read: if true;
      allow write: if isAuthenticated();
    }

    // ‚úÖ Global Admin Override
    match /{document=**} {
      allow read, write, delete: if isGlobalAdmin();
    }
  }
}
